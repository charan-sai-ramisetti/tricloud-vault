<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password | TriCloud Vault</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Auth styles -->
  <link rel="stylesheet" href="../css/auth.css" />
</head>

<body class="bg-light">

<!-- ===============================
     NAVBAR
================================ -->
<nav class="navbar bg-white border-bottom px-3">
  <div class="container-fluid">
    <span class="navbar-brand fw-semibold">TriCloud Vault</span>
  </div>
</nav>

<!-- ===============================
     RESET PASSWORD CARD
================================ -->
<main
  class="container d-flex align-items-center justify-content-center"
  style="min-height: calc(100vh - 64px);"
>
  <div class="row w-100 justify-content-center">
    <div class="col-12 col-sm-10 col-md-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body p-4">

          <h4 class="fw-semibold text-center mb-4">
            Reset Password
          </h4>

          <!-- New Password -->
          <div class="mb-3">
            <input
              type="password"
              id="newPassword"
              class="form-control"
              placeholder="New password"
              required
            />
          </div>

          <!-- Confirm Password -->
          <div class="mb-3">
            <input
              type="password"
              id="confirmPassword"
              class="form-control"
              placeholder="Confirm password"
              required
            />
          </div>

          <!-- Reset Button -->
          <button
            id="resetBtn"
            class="btn btn-primary w-100"
            onclick="resetPassword()"
          >
            Reset Password
          </button>

          <!-- Login Button (hidden initially) -->
          <button
            id="loginBtn"
            class="btn btn-outline-primary w-100 mt-2"
            style="display:none;"
            onclick="goToLogin()"
          >
            Go to Login
          </button>

          <!-- Message -->
          <p
            id="reset-msg"
            class="text-center mt-3"
            style="display:none;"
          ></p>

        </div>
      </div>
    </div>
  </div>
</main>

<!-- ===============================
     JS
================================ -->
<script src="../js/config.js"></script>

<script>
const token = new URLSearchParams(window.location.search).get("token");

/* Password validation */
function isValidPassword(password) {
  return (
    password.length >= 8 &&
    /[a-zA-Z]/.test(password) &&
    /\d/.test(password)
  );
}

/* Reset password */
function resetPassword() {
  const pwd = document.getElementById("newPassword").value;
  const confirmPwd = document.getElementById("confirmPassword").value;

  if (!pwd || !confirmPwd) {
    showMsg("All fields are required", "text-danger");
    return;
  }

  if (pwd !== confirmPwd) {
    showMsg("Passwords do not match", "text-danger");
    return;
  }

  if (!isValidPassword(pwd)) {
    showMsg(
      "Password must be at least 8 characters and include letters and numbers",
      "text-danger"
    );
    return;
  }

  fetch(`${API_BASE_URL}/auth/reset-password/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      token: token,
      password: pwd
    })
  })
    .then(res => {
      if (!res.ok) throw new Error();
      return res.json();
    })
    .then(() => {
      showMsg(
        "Password reset successful. You can login now.",
        "text-success"
      );

      document.getElementById("resetBtn").disabled = true;
      document.getElementById("loginBtn").style.display = "block";
    })
    .catch(() => {
      showMsg(
        "Invalid or expired reset link.",
        "text-danger"
      );
    });
}

/* Show message */
function showMsg(text, cls) {
  const msg = document.getElementById("reset-msg");
  msg.style.display = "block";
  msg.className = `text-center mt-3 ${cls}`;
  msg.innerText = text;
}

/* Redirect to login */
function goToLogin() {
  window.location.href = "login.html";
}
</script>

</body>
</html>
